<!DOCTYPE html>
<html>
<head>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .result-container {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            background: #f9f9f9;
            min-height: 80px;
        }
        .count {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .label {
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="result-container">
        <div class="label">Archetype Counter</div>
        <div class="count" id="choiceCount">0</div>
        <div class="error" id="errorMsg"></div>
    </div>

    <script type="text/javascript">
        // Show error message
        function showError(msg) {
            document.getElementById('errorMsg').textContent = msg;
            console.error(msg);
        }

        // Initialize widget
        function initWidget() {
            try {
                JFCustomWidget.subscribe("ready", function(data) {
                    try {
                        // Get the target archetype from the text parameter
                        var targetArchetype = JFCustomWidget.getWidgetSetting('archetype');
                        
                        if (!targetArchetype) {
                            showError('Please enter an archetype (Atlas, Seer, Envoy, or Nexus)');
                            return;
                        }
                        
                        // Update the label to show which archetype we're counting
                        document.querySelector('.label').textContent = 'Total ' + targetArchetype + ' responses:';

                        // Function to calculate total for the specified archetype
                        function calculateChoiceTotal() {
                            JFCustomWidget.getFormData(function(data) {
                                try {
                                    var questions = data.questions;
                                    var count = 0;

                                    // Loop through all questions
                                    for (var qid in questions) {
                                        var question = questions[qid];
                                        
                                        // Check if it's a single choice question and has an answer
                                        if (question.type === 'control_radio' && question.answer) {
                                            // Find the selected radio input's data-calcvalue
                                            var selectedInput = question.options.find(opt => opt.text === question.answer);
                                            if (selectedInput && selectedInput.calculationValue === targetArchetype) {
                                                count++;
                                            }
                                        }
                                    }

                                    // Update the display
                                    document.getElementById('choiceCount').textContent = count;
                                    document.getElementById('errorMsg').textContent = ''; // Clear any errors
                                } catch (err) {
                                    showError('Error calculating total: ' + err.message);
                                }
                            });
                        }

                        // Initial calculation
                        calculateChoiceTotal();

                        // Subscribe to form changes
                        JFCustomWidget.subscribe("formData", function(data) {
                            calculateChoiceTotal();
                        });

                        // Handle form submission
                        JFCustomWidget.subscribe("submit", function() {
                            var msg = {
                                valid: true,
                                value: document.getElementById('choiceCount').textContent
                            };
                            JFCustomWidget.sendSubmit(msg);
                        });
                    } catch (err) {
                        showError('Error initializing widget: ' + err.message);
                    }
                });
            } catch (err) {
                showError('Failed to load widget: ' + err.message);
            }
        }

        // Start initialization
        document.addEventListener('DOMContentLoaded', initWidget);
    </script>
</body>
</html> 