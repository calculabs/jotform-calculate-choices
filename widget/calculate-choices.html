<!DOCTYPE html>
<html>
<head>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .result-container {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            background: #f9f9f9;
            min-height: 80px;
        }
        .count {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .label {
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }
        .debug {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="result-container">
        <div class="label">Archetype Counter</div>
        <div class="count" id="choiceCount">0</div>
        <div class="error" id="errorMsg"></div>
        <div class="debug" id="debugInfo"></div>
    </div>

    <script type="text/javascript">
        // Show error message
        function showError(msg) {
            document.getElementById('errorMsg').textContent = msg;
            console.error(msg);
        }

        // Show debug info
        function showDebug(info) {
            const debugEl = document.getElementById('debugInfo');
            debugEl.textContent = typeof info === 'object' ? JSON.stringify(info, null, 2) : info;
        }

        // Initialize widget when DOM is ready
        document.addEventListener("DOMContentLoaded", function() {
            // Subscribe to ready event
            JFCustomWidget.subscribe("ready", function(data) {
                try {
                    // Get widget settings
                    const settings = JFCustomWidget.getWidgetSettings();
                    showDebug('Widget settings: ' + JSON.stringify(settings, null, 2));

                    // Get the target archetype
                    const targetArchetype = settings.archetype;
                    
                    if (!targetArchetype) {
                        showError('Please set the archetype parameter in widget settings (Atlas, Seer, Envoy, or Nexus)');
                        return;
                    }
                    
                    // Update the label
                    document.querySelector('.label').textContent = 'Total ' + targetArchetype + ' responses:';

                    // Function to update count
                    function updateCount(count) {
                        document.getElementById('choiceCount').textContent = count;
                        document.getElementById('errorMsg').textContent = '';
                        
                        // Send data back to form
                        JFCustomWidget.sendData({
                            valid: true,
                            value: count.toString()
                        });
                    }

                    // Subscribe to form changes
                    JFCustomWidget.subscribe("formData", function(formData) {
                        try {
                            showDebug('Form data: ' + JSON.stringify(formData, null, 2));
                            
                            var count = 0;
                            
                            if (formData && formData.answers) {
                                // Loop through answers
                                Object.keys(formData.answers).forEach(function(qid) {
                                    var answer = formData.answers[qid];
                                    if (answer && answer.answer === targetArchetype) {
                                        count++;
                                    }
                                });
                            }
                            
                            updateCount(count);
                        } catch (err) {
                            showError('Error processing form data: ' + err.message);
                        }
                    });

                    // Handle form submission
                    JFCustomWidget.subscribe("submit", function() {
                        JFCustomWidget.sendSubmit({
                            valid: true,
                            value: document.getElementById('choiceCount').textContent
                        });
                    });

                    // Request proper height for widget
                    JFCustomWidget.requestFrameResize({
                        height: 150
                    });

                } catch (err) {
                    showError('Error initializing widget: ' + err.message);
                }
            });
        });
    </script>
</body>
</html> 