<!DOCTYPE html>
<html>
<head>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script type="text/javascript">
        // Custom logging function that uses JotForm's messaging
        function log(type, ...args) {
            // Regular console logging
            console[type](...args);
            
            // Only send logs via JotForm if the widget API is ready
            if (window.JFCustomWidget && JFCustomWidget.sendData) {
                try {
                    JFCustomWidget.sendData({
                        valid: true,
                        value: JSON.stringify({
                            type: 'log',
                            logType: type,
                            message: args.map(arg => 
                                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                            ).join(' ')
                        })
                    });
                } catch (e) {
                    // Fallback to regular console if messaging fails
                    console.error('Failed to send log via JotForm:', e);
                }
            }
        }

        // Log that script is starting
        log('info', 'Widget script starting to load...');
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .result-container {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            background: #f9f9f9;
            min-height: 80px;
        }
        .count {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .label {
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }
        .debug {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="result-container">
        <div class="label">Archetype Counter</div>
        <div class="count" id="choiceCount">0</div>
        <div class="error" id="errorMsg"></div>
        <div class="debug" id="debugInfo"></div>
    </div>

    <script type="text/javascript">
        log('info', 'Main widget script starting...');

        // Show error message
        function showError(msg) {
            log('error', 'Widget Error:', msg);
            document.getElementById('errorMsg').textContent = msg;
        }

        // Show debug info
        function showDebug(info) {
            log('info', 'Debug Info:', info);
            const debugEl = document.getElementById('debugInfo');
            debugEl.textContent = typeof info === 'object' ? JSON.stringify(info, null, 2) : info;
        }

        // Initialize widget when DOM is ready
        document.addEventListener("DOMContentLoaded", function() {
            log('info', 'DOM Content Loaded, initializing widget...');
            
            // Subscribe to ready event
            log('info', 'Subscribing to JFCustomWidget ready event...');
            JFCustomWidget.subscribe("ready", function(data) {
                log('info', 'JFCustomWidget ready event received:', data);
                
                try {
                    let targetArchetype;
                    
                    // First try to get setting from data.settings if it exists
                    if (data.settings) {
                        try {
                            const settingsStr = data.settings;
                            log('info', 'Raw settings string:', settingsStr);
                            
                            const decodedSettings = decodeURIComponent(settingsStr);
                            log('info', 'Decoded settings:', decodedSettings);
                            
                            const settings = JSON.parse(decodedSettings);
                            log('info', 'Parsed settings:', settings);
                            
                            const archetypeSetting = settings.find(s => s.name === 'archetype');
                            targetArchetype = archetypeSetting ? archetypeSetting.value : null;
                            log('info', 'Retrieved target archetype from settings:', targetArchetype);
                        } catch (settingsErr) {
                            log('warn', 'Failed to parse settings from data:', settingsErr);
                        }
                    }
                    
                    // Fallback to getWidgetSetting if we couldn't get it from data.settings
                    if (!targetArchetype) {
                        targetArchetype = JFCustomWidget.getWidgetSetting('archetype');
                        log('info', 'Retrieved target archetype from getWidgetSetting:', targetArchetype);
                    }
                    
                    showDebug('Target archetype: ' + targetArchetype);
                    
                    if (!targetArchetype) {
                        showError('Please set the archetype parameter in widget settings (Atlas, Seer, Envoy, or Nexus)');
                        return;
                    }
                    
                    // Update the label
                    document.querySelector('.label').textContent = 'Total ' + targetArchetype + ' responses:';
                    log('info', 'Updated label for archetype:', targetArchetype);

                    // Keep track of field values
                    let fieldValues = {};
                    let count = 0;

                    // Set up listeners for specific question IDs
                    const questions = [
                        { name: 'q7_typeA' },
                        { name: 'q9_ltstronggtinKickstarting' }
                    ];
                    
                    log('info', 'Setting up listeners for questions:', questions);

                    // Function to handle radio change
                    function handleRadioChange(questionName, value) {
                        log('info', 'Radio changed for question:', questionName, 'Value:', value);
                        // If the value is the display text, try to extract data-calcvalue
                        if (value && typeof value === 'string' && value.length > 10) {
                            // This is likely the display text, get the data-calcvalue
                            fieldValues[questionName] = targetArchetype;
                            log('info', 'Using targetArchetype as value for selected radio');
                        } else {
                            fieldValues[questionName] = value;
                        }
                        updateCount();
                    }

                    // Set up listeners for each question
                    questions.forEach(question => {
                        log('info', 'Setting up listener for question:', question.name);
                        
                        // Listen to the question by name
                        try {
                            JFCustomWidget.listenFromField(question.name, 'change', function(value) {
                                log('info', 'Question changed by name:', question.name, 'Value:', value);
                                handleRadioChange(question.name, value);
                            });
                            log('info', 'Successfully set up listener for question name:', question.name);
                        } catch (err) {
                            log('warn', 'Failed to set up listener for question name:', question.name, err);
                        }

                        // Get initial value
                        JFCustomWidget.getFieldsValueById([question.name], function(data) {
                            log('info', 'Got initial value for question:', question.name, 'Data:', data);
                            if (data && data[question.name]) {
                                handleRadioChange(question.name, data[question.name]);
                            }
                        });
                    });

                    // Function to update count
                    function updateCount() {
                        log('info', 'Updating count, current values:', fieldValues);
                        let count = 0;
                        
                        // Log all current field values
                        Object.entries(fieldValues).forEach(([key, value]) => {
                            log('info', 'Checking field:', key, 'Value:', value);
                            if (value === targetArchetype) {
                                count++;
                                log('info', 'Found match in field:', key);
                            } else if (value && typeof value === 'string' && value.length > 10) {
                                // This is a display text value, check if it's from the Atlas option
                                if (value.includes('step-by-step') || value.includes('rock-solid')) {
                                    count++;
                                    log('info', 'Found match in field (by text):', key);
                                }
                            }
                        });
                        
                        log('info', 'Final count:', count);
                        document.getElementById('choiceCount').textContent = count;
                        document.getElementById('errorMsg').textContent = '';
                        
                        // Send data back to form
                        JFCustomWidget.sendData({
                            valid: true,
                            value: count.toString()
                        });
                    }

                    // Handle form submission
                    log('info', 'Subscribing to submit event...');
                    JFCustomWidget.subscribe("submit", function() {
                        log('info', 'Submit event received');
                        JFCustomWidget.sendSubmit({
                            valid: true,
                            value: document.getElementById('choiceCount').textContent
                        });
                    });

                    // Request proper height for widget
                    log('info', 'Requesting frame resize...');
                    JFCustomWidget.requestFrameResize({
                        height: 150
                    });

                } catch (err) {
                    log('error', 'Error in ready handler:', err);
                    showError('Error initializing widget: ' + err.message);
                }
            });
        });

        // Log that script has finished loading
        log('info', 'Widget script finished loading.');
    </script>
</body>
</html> 