<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>
    <script>
        JFCustomWidgetUtils.domReady(function() {
            class ArchetypeCounter {
                constructor(data) {
                    this.settings = data.settings ? JSON.parse(decodeURIComponent(data.settings)) : [];
                    this.targetArchetype = this.settings.find(s => s.name === 'archetype')?.value || 
                                         JFCustomWidget.getWidgetSetting('archetype');
                    this.questionIdsStr = this.settings.find(s => s.name === 'questionIds')?.value || 
                                        JFCustomWidget.getWidgetSetting('questionIds');
                    
                    if (!this.questionIdsStr) {
                        document.getElementById('errorMsg').textContent = 
                            'Please set the questionIds parameter in widget settings (comma-separated list of question IDs)';
                        return;
                    }

                    this.questionIds = this.questionIdsStr.split(',').map(id => parseInt(id.trim()));

                    if (!this.targetArchetype) {
                        document.getElementById('errorMsg').textContent = 
                            'Please set the archetype parameter in widget settings (Atlas, Seer, Envoy, or Nexus)';
                        return;
                    }

                    // Update the label
                    document.querySelector('.label').textContent = 'Total ' + this.targetArchetype + ' responses:';

                    // Initialize state
                    this.fieldValues = {};
                    window.fieldValues = this.fieldValues; // Make it accessible for debugging

                    // Ensure the widget has the calculatedOperand class
                    const container = document.querySelector('.result-container');
                    if (container) {
                        container.classList.add('calculatedOperand');
                    }

                    // Tell JotForm to add calculatedOperand class to our parent li
                    JFCustomWidget.sendData({
                        valid: true,
                        value: 'add-calculated-class',
                        type: 'customEvent',
                        callback: function() {
                            // After class is added, ensure our widget is treated as a calculated field
                            JFCustomWidget.sendData({ 
                                valid: true, 
                                value: '0',
                                calculated: true
                            });
                        }
                    });

                    // Set up listeners
                    this.setupListeners();

                    // Set up frame height
                    JFCustomWidget.requestFrameResize({ height: 100 });

                    // Initial update
                    this.updateCount();

                    // Log initial state
                    this.logState('Widget initialized');
                }

                setupListeners() {
                    // Set up listeners for questions
                    this.questionIds.forEach(id => {
                        window.OPTION_INDICES.forEach(option => {
                            const inputId = `input_${id}_${option}`;
                            JFCustomWidget.listenFromField(inputId, 'change', value => {
                                if (value && value !== 'false') {
                                    this.fieldValues[`q${id}`] = window.ARCHETYPE_MAP[option];
                                    this.updateCount();
                                    this.logState(`Field ${inputId} changed to ${value}`);
                                }
                            });
                        });
                    });

                    // Handle form submission
                    JFCustomWidget.subscribe("submit", () => {
                        JFCustomWidget.sendSubmit({
                            valid: true,
                            value: document.getElementById('choiceCount').textContent
                        });
                    });
                }

                updateCount() {
                    const count = Object.values(this.fieldValues)
                        .filter(value => value === this.targetArchetype)
                        .length;
                    
                    document.getElementById('choiceCount').textContent = count;
                    
                    // Send data to JotForm as a calculated value
                    JFCustomWidget.sendData({ 
                        valid: true, 
                        value: count.toString(),
                        calculated: true // Mark this as a calculated value
                    });

                    // Also send the value in the format JotForm expects for calculated fields
                    JFCustomWidget.sendSubmit({
                        valid: true,
                        value: count.toString(),
                        calculated: true
                    });

                    // Update debug panel
                    const debugPanel = document.getElementById('debugPanel');
                    if (debugPanel) {
                        debugPanel.innerHTML = `
                            <h4>Debug Info:</h4>
                            <pre>Field Values: ${JSON.stringify(this.fieldValues, null, 2)}</pre>
                            <pre>Current Count: ${count}</pre>
                            <pre>Target Archetype: ${this.targetArchetype}</pre>
                            <pre>Question IDs: ${this.questionIds.join(', ')}</pre>
                        `;
                    }
                }

                logState(message) {
                    const state = {
                        message: message,
                        isVisible: document.querySelector('.result-container').style.display !== 'none',
                        currentCount: document.getElementById('choiceCount').textContent,
                        fieldValues: this.fieldValues,
                        targetArchetype: this.targetArchetype,
                        questionIds: this.questionIds,
                        timestamp: new Date().toISOString()
                    };

                    // Send debug info to parent window
                    JFCustomWidget.sendData({
                        valid: true,
                        value: JSON.stringify({
                            type: 'debug',
                            state: state
                        })
                    });

                    // Also log to console for direct debugging
                    console.log('=== Widget State ===');
                    console.log('Message:', message);
                    console.log('Is widget visible:', state.isVisible);
                    console.log('Current count:', state.currentCount);
                    console.log('Field values:', state.fieldValues);
                    console.log('Target archetype:', state.targetArchetype);
                    console.log('Question IDs:', state.questionIds);
                    console.log('Timestamp:', state.timestamp);
                }
            }

            // Initialize widget when ready
            JFCustomWidget.subscribe("ready", function(data) {
                try {
                    window.widget = new ArchetypeCounter(data);
                } catch (err) {
                    document.getElementById('errorMsg').textContent = 'Error initializing widget: ' + err.message;
                }
            });
        });
    </script>
    <script type="module">
        import { ARCHETYPE_MAP, OPTION_INDICES } from './map.js';
        import { log } from './logger.js';

        // Make necessary objects available globally
        window.ARCHETYPE_MAP = ARCHETYPE_MAP;
        window.OPTION_INDICES = OPTION_INDICES;
        window.log = log;
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .result-container {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            background: #f9f9f9;
            margin-bottom: 10px;
        }
        .count {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .label {
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .error {
            color: #e74c3c;
            font-size: 12px;
        }
        #debugPanel {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: #f5f5f5;
            font-size: 12px;
            margin-top: 10px;
        }
        #debugPanel h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        #debugPanel pre {
            margin: 5px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="result-container">
        <div class="label">Archetype Counter</div>
        <div class="count" id="choiceCount">0</div>
        <div class="error" id="errorMsg"></div>
    </div>

    <div id="debugPanel">
        <h4>Debug Info:</h4>
        <pre>Loading...</pre>
    </div>
</body>
</html> 